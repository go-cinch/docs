# 环境准备


启动项目前, 我默认你已准备好(部分软件按建议方式安装即可): 
- [go](https://golang.org/dl)1.18+(建议使用[g](https://github.com/voidint/g))
  ```bash
  curl -sSL https://raw.githubusercontent.com/voidint/g/master/install.sh | bash
  echo "unalias g" >> ~/.bashrc
  source "$HOME/.g/env"
  # g --version
  # g version 1.5.0
  
  g install 1.18
  # go version
  # go version go1.18 linux/amd64
  
  echo "export GOPATH=/home/ubuntu" >> ~/.bashrc 
  # 设置go/bin目录到PATH, 若不设置, go安装的一些文件无法识别
  echo "export PATH=$PATH:/home/ubuntu/.g/go/bin:$GOPATH/go/bin" >> ~/.bashrc
  source ~/.bashrc
  ```
- 开启go modules
- [mysql](https://www.mysql.com)(本地测试建议使用docker-compose搭建)
- [redis](https://redis.io)(本地测试建议使用docker-compose搭建)
  ```bash
  # 安装docker
  sudo apt-get update
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  sudo apt-key fingerprint 0EBFCD88
  sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  sudo apt-get update
  sudo apt-get install -y docker-ce
  # sudo docker -v
  # Docker version 23.0.1, build a5ee5b1

  # 国内加速安装
  sudo apt-get update
  sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
  curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
  sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
  sudo apt-get update
  sudo apt-get install -y docker-ce
  # sudo docker -v
  # Docker version 23.0.1, build a5ee5b1

  # 去除docker sudo
  sudo groupadd docker
  sudo gpasswd -a ${USER} docker
  sudo systemctl restart docker
  sudo chmod a+rw /var/run/docker.sock
  # docker -v
  # Docker version 23.0.1, build a5ee5b1

  # docker-compose
  sudo curl -L https://github.com/docker/compose/releases/download/v2.10.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
  sudo chmod +x /usr/local/bin/docker-compose
  # docker-compose -v
  # Docker Compose version v2.10.2

  
  # 简单启动一个单机版mysql和redis
  git clone https://github.com/go-cinch/compose
  cd compose/single
  # 修改默认密码
  source myenv
  docker-compose -f docker-compose.db.yml up -d redis mysql
  # docker ps
  # CONTAINER ID  IMAGE         COMMAND                 CREATED            STATUS         PORTS                                                 NAMES
  # 918328d0aae1  mysql:8.0.19  "docker-entrypoint.s…"  About an hour ago  Up 59 minutes  0.0.0.0:3306->3306/tcp, :::3306->3306/tcp, 33060/tcp  mysql
  # 918b2cfcd72e  redis:7.0     "docker-entrypoint.s…"  About an hour ago  Up 59 minutes  0.0.0.0:6379->6379/tcp, :::6379->6379/tcp             redis
  ```
- [protoc](https://github.com/protocolbuffers/protobuf)
  ```bash
  curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.20.3/protoc-3.20.3-`uname -s`-`uname -m`.zip
  sudo unzip protoc-3.20.3-`uname -s`-`uname -m`.zip -d /usr
  # protoc --version
  # libprotoc 3.20.3
  ```
- [protoc-gen-go](https://github.com/protocolbuffers/protobuf-go)
  ```bash
  go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28.1
  # protoc-gen-go --version
  # protoc-gen-go v1.28.1
  ```
- [git](https://git-scm.com)
- [kratos cli工具](https://go-kratos.dev/docs/getting-started/usage)
  ```bash
  go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
  # kratos -v
  kratos version v2.5.3
  ```


# [Auth服务](https://github.com/go-cinch/auth)


权限认证服务无需再开发, 下载开箱即用

```bash
git clone https://github.com/go-cinch/auth
# 可以指定tag
# git clone -b v1.0.1 https://github.com/go-cinch/auth
```


# 创建Game服务


```bash
# 1.通过模板创建项目 -r 指定仓库 -b 指定分支
kratos new game -r https://github.com/go-cinch/layout.git -b dev

# 2. 进入项目
cd game
# 一般的我们建议以dev作为开发分支
git init -b dev

# 3. 初始化submodule
# -b指定分支 --name指定submodule名称
git submodule add -b master --name api/auth-proto https://github.com/go-cinch/auth-proto.git ./api/auth-proto

# -b指定分支 --name指定submodule名称
git submodule add -b master --name api/reason-proto https://github.com/go-cinch/reason-proto.git ./api/reason-proto

# 这里用game作为示例, 按需修改
# -b指定分支 --name指定submodule名称
git submodule add -b master --name api/game-proto https://github.com/go-cinch/game-proto.git ./api/game-proto

# 删除一个已经存在的submodule
# git submodule deinit api/game-proto
# git rm --cached api/game-proto
# rm -rf .git/modules/api/game-proto
# rm -rf api/game-proto


# 4. 将layout关键词全部替换(Unix)
sed -i "" "s/layout/game/g" `grep -rl "layout" .`

# 5. 下载依赖
go mod tidy

# 6. 编译项目
make all
```

如果项目名是其他, 可以用下面的方式快速全部替换(Unix)  
```bash
export PRO_NAME=order
export PRO_NAME_UP=Order
kratos new $PRO_NAME -r https://github.com/go-cinch/layout.git -b dev
cd $PRO_NAME
git init -b dev
git submodule add -b master --name api/auth-proto https://github.com/go-cinch/auth-proto.git ./api/auth-proto
git submodule add -b master --name api/reason-proto https://github.com/go-cinch/reason-proto.git ./api/reason-proto
git submodule add -b master --name api/$PRO_NAME-proto https://github.com/go-cinch/$PRO_NAME-proto.git ./api/$PRO_NAME-proto
sed -i "" "s/Game/$PRO_NAME_UP/g" `grep -rl "Game" .`
sed -i "" "s/game/$PRO_NAME/g" `grep -rl "game" .`
sed -i "" "s/layout/$PRO_NAME/g" `grep -rl "layout" .`
mv ./internal/biz/game.go ./internal/biz/$PRO_NAME.go
mv ./internal/service/game.go ./internal/service/$PRO_NAME.go
mv ./internal/data/game.go ./internal/data/$PRO_NAME.go
go fmt ./...
go mod tidy
make all
```

# 启动


## 配置文件


```bash
# 修改auth项目配置
# 将mysql/redis的配置修改成你本地配置
vim auth/configs/conifg.yaml

# 修改game项目配置
# 将mysql/redis的配置修改成你本地配置
vim game/configs/conifg.yaml
# 将auth服务host和端口修改成你本地配置
vim game/configs/client.yaml

# 启动auth
cd auth
kratos run

# 启动game
cd game
kratos run
```


## 环境变量


```bash
# 启动auth
cd auth
export AUTH_DATA_DATABASE_DSN='root:root@tcp(127.0.0.1:3306)/auth?parseTime=True'
export AUTH_DATA_REDIS_DSN='redis://127.0.0.1:6379/0'
kratos run

# 启动game
cd game
export CINCH_DATA_DATABASE_DSN='root:root@tcp(127.0.0.1:3306)/game?parseTime=True'
export CINCH_DATA_REDIS_DSN='redis://127.0.0.1:6379/0'
export CINCH_CLIENT_AUTH='127.0.0.1:6160'
kratos run
```

?> Tips: 环境变量前缀可在cmd/xxx/main.go中修改, 参见[环境变量前缀](/base/0.config?id=%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%89%8d%e7%bc%80)


## 测试访问


auth服务: 
```bash
curl http://127.0.0.1:6060/idempotent
# 输出如下说明服务通了只是没有权限, 出现其他说明配置有误
# {"code":401, "reason":"UNAUTHORIZED", "message":"token is missing", "metadata":{}}
```

game服务: 
```bash
curl http://127.0.0.1:8080/greeter
# 输出如下说明服务通了只是没有权限, 出现其他说明配置有误
# {"code":401, "reason":"UNAUTHORIZED", "message":"token is missing", "metadata":{}}
```

## 关闭Idempotent鉴权

为了测试方便, 暂时关闭鉴权
```bash
vim auth/internal/server/middleware/whitelist.go
```

增加以下内容
```go
	whitelist[auth.OperationAuthIdempotent] = struct{}{}
```

?> Tips: 上述代码表示将idempotent这个接口加入白名单, 跳过鉴权


重启auth服务再测试:
```bash
curl http://127.0.0.1:6060/idempotent
# 输出包含token字段说明配置对了
# {"token":"041c12d3-ddd0-4c63-b3fb-454f3e7ec40a"}
```

!> 仅用作本地测试, 正式环境还是开启权限校验, 避免恶意调用


?> 至此, 微服务已启动完毕, auth以及game, 接下来可以自定义你的game啦~
